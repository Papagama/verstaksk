<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel — Artisan Dev</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=2">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23000'/%3E%3Cpath d='M18 44L26 20H30L38 44H34L32.2 38.8H23.8L22 44H18ZM24.8 35.6H31.2L28 25.2L24.8 35.6Z' fill='%23FF4D00'/%3E%3Cpath d='M42 20H48C50.4 20 52.4 20.8 54 22.4C55.6 24 56.4 26 56.4 28.4V35.6C56.4 38 55.6 40 54 41.6C52.4 43.2 50.4 44 48 44H42V20ZM46 40H48C49.6 40 50.8 39.5 51.6 38.5C52.4 37.5 52.8 36.3 52.8 34.8V29.2C52.8 27.7 52.4 26.5 51.6 25.5C50.8 24.5 49.6 24 48 24H46V40Z' fill='%23FFF'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #FF4D00;
            --bg: #FFFFFF;
            --text: #000000;
            --text-muted: #666666;
            --font-main: 'Inter', sans-serif;
            --font-head: 'Montserrat', sans-serif;
        }

        body { font-family: var(--font-main); padding: 40px 20px; color: var(--text); background: #fcfcfc; line-height: 1.5; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { font-family: var(--font-head); text-transform: uppercase; font-size: 2.5rem; margin-bottom: 30px; letter-spacing: -0.05em; }
        
        .back-link { display: inline-block; margin-bottom: 20px; color: var(--accent); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
        
        .card { background: #fff; padding: 40px; border: 1px solid #eee; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); }
        h2 { font-family: var(--font-head); font-size: 1.2rem; margin-bottom: 24px; text-transform: uppercase; border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 4px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 8px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; font-family: inherit; font-size: 1rem; border-radius: 0; }
        input:focus, textarea:focus { outline: none; border-color: var(--accent); }

        .image-preview { 
            width: 100%; 
            height: 250px; 
            background: #f8f8f8; 
            border: 2px dashed #ddd; 
            margin-top: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            position: relative;
        }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview span { color: #999; font-size: 0.8rem; text-align: center; padding: 20px; }

        .btn { background: var(--text); color: #fff; border: none; padding: 18px 30px; font-family: var(--font-head); font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.3s; width: 100%; letter-spacing: 0.1em; }
        .btn:hover { background: var(--accent); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .works-list { list-style: none; padding: 0; }
        .work-item { display: flex; align-items: center; gap: 20px; padding: 20px 0; border-bottom: 1px solid #eee; }
        .work-item img { width: 80px; height: 50px; object-fit: cover; background: #eee; border: 1px solid #eee; }
        .work-meta { flex-grow: 1; }
        .work-meta h4 { font-family: var(--font-head); font-size: 1rem; margin: 0; }
        .work-meta p { font-size: 0.8rem; color: var(--text-muted); margin: 4px 0 0 0; }
        .work-meta a { font-size: 0.75rem; color: var(--accent); text-decoration: none; word-break: break-all; }
        .work-meta a:hover { text-decoration: underline; }
        
        .delete-btn { color: #ff0000; background: none; border: 1px solid rgba(255,0,0,0.1); padding: 8px 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .delete-btn:hover { background: #ff0000; color: #fff; }

        .status-msg { font-size: 0.8rem; margin-top: 10px; display: none; }
        .status-msg.active { display: block; color: var(--accent); font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← На главную</a>
        <h1>Управление проектами</h1>

        <div class="card">
            <h2>Добавить новую работу</h2>
            <form id="add-work-form">
                <div class="form-group">
                    <label>Название проекта</label>
                    <input type="text" id="title" required placeholder="Напр: Burger King Rebrand">
                </div>
                <div class="form-group">
                    <label>Категория (Тег)</label>
                    <input type="text" id="tag" required placeholder="Напр: Landing Page / UI Design">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="description" rows="2" required placeholder="Коротко о том, что было сделано..."></textarea>
                </div>
                <div class="form-group">
                    <label>Ссылка на проект</label>
                    <input type="url" id="project-url" placeholder="https://example.com">
                </div>
            
                <div class="form-group">
                    <label>Обложка проекта</label>
                    <input type="file" id="image-file" accept="image/*" style="padding: 10px 0;">
                    <div id="status-compress" class="status-msg">Сжимаем изображение для быстрой загрузки...</div>
                    <div class="image-preview" id="preview">
                        <span>Загрузите фото проекта<br>(Оно будет автоматически оптимизировано)</span>
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="btn">Опубликовать в портфолио</button>
            </form>
        </div>

        <div class="card">
            <h2>Опубликованные работы</h2>
            <ul id="works-list" class="works-list">
                <!-- Работы -->
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('add-work-form');
            const list = document.getElementById('works-list');
            const fileInput = document.getElementById('image-file');
            const preview = document.getElementById('preview');
            const submitBtn = document.getElementById('submit-btn');
            const compressMsg = document.getElementById('status-compress');
            
            let currentImageData = '';

            // Функция сжатия изображения
            const compressImage = (base64Str) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Максимальные размеры для оптимизации
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 600;
                        
                        // Пропорциональное изменение размера
                        if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                            const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                            width *= ratio;
                            height *= ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Улучшенное качество рендеринга
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Пробуем WebP, если поддерживается (лучшее сжатие)
                        let result = canvas.toDataURL('image/webp', 0.80);
                        
                        // Проверяем размер - если больше 500KB, ужимаем еще сильнее
                        if (result.length > 500000) {
                            result = canvas.toDataURL('image/webp', 0.60);
                        }
                        
                        // Если WebP не поддерживается, используем JPEG
                        if (!result.includes('image/webp')) {
                            result = canvas.toDataURL('image/jpeg', 0.75);
                            if (result.length > 500000) {
                                result = canvas.toDataURL('image/jpeg', 0.55);
                            }
                        }
                        
                        // Проверка финального размера
                        const sizeInMB = (result.length / 1024 / 1024).toFixed(2);
                        console.log(`Изображение сжато: ${sizeInMB} MB`);
                        
                        if (result.length > 1000000) { // Больше 1 MB
                            reject(new Error('Изображение слишком большое даже после сжатия. Попробуйте использовать изображение меньшего размера.'));
                        } else {
                            resolve(result);
                        }
                    };
                    img.onerror = () => {
                        reject(new Error('Ошибка загрузки изображения'));
                    };
                });
            };

            const updatePreview = (src) => {
                if(!src) {
                    preview.innerHTML = '<span>Загрузите фото проекта<br>(Оно будет автоматически оптимизировано)</span>';
                    currentImageData = '';
                    return;
                }
                preview.innerHTML = `<img src="${src}" alt="Preview">`;
                currentImageData = src;
            };

            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Проверяем размер файла
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                    console.log(`Загружен файл: ${file.name}, размер: ${fileSizeMB} MB`);
                    
                    if (file.size > 10 * 1024 * 1024) { // Больше 10 MB
                        alert('⚠️ Файл слишком большой! Пожалуйста, используйте изображение размером до 10 MB.\n\nРекомендую воспользоваться инструментом "optimize-images.html" для оптимизации.');
                        fileInput.value = '';
                        return;
                    }
                    
                    submitBtn.disabled = true;
                    compressMsg.classList.add('active');
                    compressMsg.textContent = 'Сжимаем изображение для быстрой загрузки...';
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const compressed = await compressImage(event.target.result);
                            updatePreview(compressed);
                            
                            submitBtn.disabled = false;
                            compressMsg.classList.remove('active');
                            compressMsg.textContent = 'Сжимаем изображение для быстрой загрузки...';
                        } catch (error) {
                            alert('❌ ' + error.message);
                            submitBtn.disabled = false;
                            compressMsg.classList.remove('active');
                            fileInput.value = '';
                            updatePreview('');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            const getWorks = () => {
                const saved = localStorage.getItem('portfolio_works');
                return saved ? JSON.parse(saved) : [];
            };

            const saveWorks = (works) => {
                try {
                    const data = JSON.stringify(works);
                    const dataSizeMB = (data.length / 1024 / 1024).toFixed(2);
                    
                    // LocalStorage лимит обычно 5-10 MB
                    if (data.length > 5 * 1024 * 1024) {
                        throw new Error('Превышен лимит памяти браузера (5 MB). Удалите старые работы или используйте меньшие изображения.');
                    }
                    
                    console.log(`Сохраняем данные: ${dataSizeMB} MB`);
                    localStorage.setItem('portfolio_works', data);
                    renderList();
                } catch (e) {
                    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                        alert('⚠️ Память браузера переполнена!\n\n' +
                              'LocalStorage имеет лимит 5-10 MB.\n\n' +
                              'Решения:\n' +
                              '1. Удалите старые работы\n' +
                              '2. Используйте optimize-images.html для сжатия\n' +
                              '3. Загружайте изображения на внешний хостинг (Imgur, Cloudinary)');
                    } else {
                        alert('❌ Ошибка сохранения: ' + e.message);
                    }
                    console.error('Storage error:', e);
                }
            };

            const renderList = () => {
                if (!list) return;
                const works = getWorks();
                
                list.innerHTML = works.length ? works.map((work) => `
                    <li class="work-item">
                        <a href="${work.url || '#'}" target="_blank">
                        <img src="${work.image}" alt=""> 
                        </a>
                        
                        <div class="work-meta">
                            <h4>${work.title}</h4>
                            <p>${work.tag}</p>
                            ${work.url ? `<a href="${work.url}" target="_blank">${work.url}</a>` : ''}
                        </div>
    
                        <button class="delete-btn" data-id="${work.id}">Удалить</button>
                    </li>
                `).join('') : '<p style="color: #999; text-align: center; padding: 20px;">Вы еще не добавили ни одного проекта</p>';

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        if(confirm('Удалить этот проект из портфолио?')) {
                            const id = parseInt(e.target.dataset.id);
                            const filtered = getWorks().filter(w => w.id !== id);
                            saveWorks(filtered);
                        }
                    };
                });
            };

            form.onsubmit = (e) => {
                e.preventDefault();
                
                if (!currentImageData) {
                    alert('Пожалуйста, выберите изображение проекта');
                    return;
                }

                const newWork = {
                    id: Date.now(),
                    title: document.getElementById('title').value,
                    tag: document.getElementById('tag').value,
                    description: document.getElementById('description').value,
                    url: document.getElementById('project-url').value,
                    image: currentImageData
                };

                const works = getWorks();
                saveWorks([...works, newWork]);
                
                form.reset();
                updatePreview('');
                alert('Проект успешно добавлен и опубликован!');
            };

            renderList();
        });
    </script>
</body>
</html>